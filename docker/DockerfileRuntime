ARG DEVICE=latest

FROM mdnf1992/cpp-dev:${DEVICE} AS build

COPY . /src

RUN mkdir -p /src/build && cd /src/build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/app -DIMPORT_ALL_RUNTIME=OFF -DBUILD_TESTING=OFF && \
    make -j4 install

FROM debian:trixie-slim AS runtime

COPY --from=build /app /usr/local

RUN ldconfig

# Various targets
FROM runtime AS rplidar 

ENTRYPOINT ["/usr/local/bin/rplidar_publisher"]

FROM runtime AS mid360

ENTRYPOINT ["/usr/local/bin/mid360_publisher", "/usr/local/etc/mid360_config.json"]
CMD ["100", "1", "0"]

FROM runtime AS icm20948

ENTRYPOINT ["/usr/local/bin/icm20948_publisher"]
CMD ["1"]

# One can use `scratch` as a base and manually call the copied `ld` binary.
# Use -DIMPORT_ALL_RUNTIME=ON when building for scratch.
# RUN chmod +x /app/lib/ld-linux-aarch64.so.1
# FROM scratch AS runtime
# CMD ["/usr/local/lib/ld-linux-aarch64.so.1", "--library-path=/usr/local/lib", "/usr/local/bin/sim_publisher"]